'use strict';

var services = angular.module('parkedex.services');

/**
 *	Handling Parking data
 */
services.factory('FeedbackService', ['QueryService', '$timeout', '$q', 'ViewService', '$window', '$ionicPopup', 'MapService', function(QueryService, $timeout, $q, ViewService, $window, $ionicPopup, MapService) {
	
	var addresses = [];

	var boxanimation = null;
	
	var _self =  {
		showMissingAddressBox : function (address) {
			if (addresses.indexOf (address) !== -1) return;
			addresses.push (address);
			console.log ('nothing found at:' + address);
			
			var el = $window.document.getElementById ('missingAddressBox');
			ViewService.show (el);
			
			/*var el2 = $window.document.getElementById ('missingAddressListBox');
			ViewService.show (el2);*/
		}, 
		hideMissingAddressBox : function () {
			
			var el = $window.document.getElementById ('missingAddressBox');
			ViewService.hide (el);
			
			/*var el2 = $window.document.getElementById ('missingAddressListBox');
			ViewService.hide (el2);*/
		},
		sendMissingAddressFeedback : function () {
			var feedbackparams = {
				address : addresses [addresses.length-1]
			};
			QueryService.callWebRemote ('feedback', feedbackparams).then (function (response) {
				_self.showFeedbackConfirmation ();
			}, function (error) {
				console.log (JSON.stringify (error));
				_self.showFeedbackFailedMessage ();
				console.log ('Feedback API could not be reached.');
			}).finally (function () {
				_self.hideMissingAddressBox ();
			});
		},
		showFeedbackConfirmation : function () {
			var alertPopup = $ionicPopup.show({
				cssClass: 'popupCityFeedback',
				subTitle: 'Vielen Dank f√ºr dein Feedback!'
			});
			alertPopup.then(function(res) {
				console.log('gemeldete Stadt: ' + addresses[addresses.length-1]);
			});
			$timeout(function() {
				alertPopup.close();
			}, 2000);
		}, 
		showFeedbackFailedMessage : function () {
			var alertPopup = $ionicPopup.show({
				cssClass: 'popupCityFeedback',
				subTitle: 'Es gab leider einen Fehler mit unserem Server. Tut uns Leid.'
			});
			alertPopup.then(function(res) {
				
			});
			$timeout(function() {
				alertPopup.close();
			}, 2000);
		}, 
		showErrorMessage : function (message) {
			var alertPopup = $ionicPopup.show({
				cssClass: 'popupCityFeedback',
				subTitle: message
			});
			alertPopup.then(function(res) {
				
			});
			$timeout(function() {
				alertPopup.close();
			}, 3000);
		}
	}
	
	return _self;
}]);